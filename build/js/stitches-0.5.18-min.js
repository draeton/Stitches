(function(b,c,d){var a=b.Stitches=(function(){var e={jsdir:"js",prefix:"sprite",padding:10,dataURI:false};return{init:function(f,g){a.settings=c.extend({},e,g);a.iconQueue=[];a.topics={};a.Page.$elem=f;a.sub("page.error",a.Page.errorHandler);a.sub("page.init.done",a.Page.fetchTemplates);a.sub("page.templates.done",a.Page.render);a.sub("page.render.done",a.checkAPIs);a.sub("page.apis.done",a.Page.bindDragAndDrop);a.sub("page.apis.done",a.Page.bindButtons);a.sub("page.apis.done",a.Page.bindCabinet);a.sub("page.apis.done",a.Page.bindOptions);a.sub("page.apis.done",a.Page.subscribe);a.sub("page.drop.done",a.File.queueFiles);a.sub("file.queue.done",a.File.queueIcons);a.sub("file.icon.done",a.Page.addIcon);a.sub("file.remove.done",a.Page.removeIcon);a.sub("file.unqueue",a.File.unqueueIcon);a.sub("file.unqueue.all",a.File.unqueueAllIcons);a.sub("sprite.generate",a.generateStitches);a.pub("page.init.done")},sub:function(f,g){var h=a.topics[f]||c.Callbacks("stopOnFalse");if(g){h.add(g)}a.topics[f]=h},unsub:function(f,g){var h=a.topics[f];if(h){h.remove(g)}},pub:function(g){var h=a.topics[g],f=Array.prototype.slice.call(arguments,1);if(h){h.fire.apply(h,f)}},checkAPIs:function(){d.load([{test:typeof FileReader!=="undefined"&&d.draganddrop,nope:a.settings.jsdir+"/dropfile/dropfile.js"},{test:d.canvas,nope:a.settings.jsdir+"/flashcanvas/flashcanvas.js",complete:function(){if(typeof FileReader!=="undefined"&&d.draganddrop&&d.canvas){a.pub("page.apis.done")}else{a.pub("page.error",new Error("Required APIs are not present."))}}}])},generateStitches:function(i){var h=a.positionImages(i);var g=a.makeStitches(h);var f=a.makeStylesheet(h,g);a.pub("sprite.generate.done",g,f)},positionImages:function(g){var f=[];c(g).each(function(h,i){i.x=i.y=0;i.isPlaced=false});g=g.sort(function(i,h){if(h.area===i.area){return h.name>i.name?1:-1}else{return h.area-i.area}});a.canvas=a.Icons.idealCanvas(g);a.Icons.placeIcons(g,f,a.canvas);a.Icons.cropCanvas(f,a.canvas);a.pub("sprite.position.done",f);return f},makeStitches:function(g){var f,h;try{f=a.canvas.getContext("2d");c(g).each(function(j,k){f.drawImage(k.image,k.x,k.y)});h=a.canvas.toDataURL("image/png")}catch(i){a.pub("page.error",i)}a.pub("sprite.image.done",h);return h},makeStylesheet:function(h,g){h=h.sort(function(m,l){return m.name<l.name?-1:1});var j=a.settings.prefix;var k;if(a.settings.dataURI){k=g}else{k="download.png"}var f=["."+j+" {","    background: url("+k+") no-repeat;","}\n"];c(h).each(function(l,m){f=f.concat(["."+j+"-"+m.name+" {","    width: "+m.image.width+"px;","    height: "+m.image.height+"px;","    background-position: -"+m.x+"px -"+m.y+"px;","}\n"])});var i="data:text/plain,"+encodeURIComponent(f.join("\n"));a.pub("sprite.stylesheet.done",i);return i},dataToObjectURL:function(m){var o=m.split(",");var l;if(o[0].indexOf("base64")>=0){l=atob(o[1])}else{l=unescape(o[1])}var k=o[0].split(":")[1].split(";")[0];var h=l.length;var p=new ArrayBuffer(h);var j=new Uint8Array(p);var n;for(n=0;n<h;n++){j[n]=l.charCodeAt(n)}var f=a.createBlob(p,k);var g=a.createObjectURL(f);return g},createBlob:function(g,f){var h=h||WebKitBlobBuilder;if(!h){throw new Error("BlobBuilder is unsupported.")}var i=new h();i.append(g);return i.getBlob(f)},createObjectURL:function(f){if(b.URL&&b.URL.createObjectURL){return b.URL.createObjectURL(f)}if(b.webkitURL&&b.webkitURL.createObjectURL){return b.webkitURL.createObjectURL(f)}throw new Error("createObjectURL is unsupported.")}}})()})(window,jQuery,Modernizr);(function(a,c,b){c.Icons=(function(){var e=a.Stitches;var d=a.document;return{idealCanvas:function(k){var m=0;var h=0;var l=0;b(k).each(function(n,o){m=o.width>m?o.width:m;h=o.height>h?o.height:h;l+=o.area});var g=Math.ceil(Math.sqrt(l));var f=m>g?m:g;var j=h>g?h:g;var i=d.createElement("canvas");i.width=f;i.height=j;return i},placeIcons:function(j,h,f){var g=0;while(j.length&&g<10){b(j).each(function(i,k){if(!k.isPlaced){k.isPlaced=e.Icons.placeIcon(k,h,f)}});g++}for(g=0;g<j.length;g++){if(j[g].isPlaced){j.splice(g)}}return true},placeIcon:function(k,l,h){var j=0;while(j<2){for(var m=0;m<=h.height-k.height;m++){for(var f=0;f<=h.width-k.width;f++){k.x=f;k.y=m;var g=e.Icons.isOverlapped(k,l);if(!g){return true}f=g.x+g.width}m=g.y+g.height}h.width+=k.width;h.height+=k.height;j++}return false},isOverlapped:function(l,m){var i,h,k,j;var f=[];var g=null;b(m).each(function(n,o){i=(o.x<l.x+l.width);h=(o.x+o.width>l.x);k=(o.y<l.y+l.height);j=(o.y+o.height>l.y);if(i&&h&&k&&j){f.push(o)}});if(f.length){g=f.pop()}else{m.push(l)}return g},cropCanvas:function(j,g){var f=0,i=0;b(j).each(function(h,k){f=f>k.x+k.width?f:k.x+k.width;i=i>k.y+k.height?i:k.y+k.height});g.width=f;g.height=i}}})()})(window,Stitches,jQuery);(function(a,b){b.Icon=(function(){var e=a.Stitches;var d=0;var f={};var c=function(i,j,g){var h=this;this.guid=d++;this.name=e.Icon.getName(i);this.image=new Image();this.image.onload=function(){h.x=0;h.y=0;h.width=h.image.width+e.settings.padding;h.height=h.image.height+e.settings.padding;h.area=h.width*h.height;if(g){g(h)}};this.image.src=j};c.getName=function(h){var j=1,g;h=h.replace(/\.\w+?$/gi,"").replace(/[\s.]+/gi,"-").replace(/[^a-z0-9\-]/gi,"_");if(f[h]){do{g=h+"-"+j++}while(f[g]);h=g}f[h]=true;return h};c.clearNameCache=function(g){if(g){delete f[g]}else{f={}}};return c})()})(window,Stitches);(function(){var b={};Stitches.tmpl=function a(e,d){var c=!/\W/.test(e)?b[e]=b[e]||a(document.getElementById(e).innerHTML):new Function("obj","var p=[],print=function(){p.push.apply(p,arguments);};with(obj){p.push('"+e.replace(/[\r\t\n]/g," ").split("<%").join("\t").replace(/((^|%>)[^\t]*)'/g,"$1\r").replace(/\t=(.*?)%>/g,"',$1,'").split("\t").join("');").split("%>").join("p.push('").split("\r").join("\\'")+"');}return p.join('');");return d?c(d):c}})();(function(a,c,b){c.Page=(function(){var d=a.Stitches;var e=false;return{fetchTemplates:function(){return b.get(d.settings.jsdir+"/stitches.html",function(f){b("body").append(f);d.Page.templates={stitches:d.tmpl("stitches_tmpl"),icon:d.tmpl("stitches_icon_tmpl")};d.pub("page.templates.done")})},render:function(){var f=b(d.Page.templates.stitches({}));f.appendTo(d.Page.$elem);d.Page.$stitches=b(".stitches",d.Page.$elem);d.Page.$drawer=b(".drawer",d.Page.$elem);d.Page.$dropbox=b(".dropbox",d.Page.$elem);d.Page.$droplabel=b(".droplabel",d.Page.$elem);d.Page.$filelist=b(".filelist",d.Page.$elem);d.Page.$buttons=b(".buttons",d.Page.$elem);d.Page.buttons={$generate:b("a.generate",d.Page.$buttons),$clear:b("a.clear",d.Page.$buttons),$sprite:b("a.dlsprite",d.Page.$buttons),$stylesheet:b("a.dlstylesheet",d.Page.$buttons)};d.Page.$options=b(".options",d.Page.$elem);d.Page.inputs={$prefix:b("input[name=prefix]",d.Page.$options),$padding:b("input[name=padding]",d.Page.$options),$dataURI:b("input[name=dataURI]",d.Page.$options)};d.Page.inputs.$prefix.val(d.settings.prefix);d.Page.inputs.$padding.val(d.settings.padding);d.Page.inputs.$dataURI.filter("[value="+d.settings.dataURI+"]").attr("checked",true);e=true;d.pub("page.render.done")},errorHandler:function(f){if(e){d.Page.$droplabel.html("&times; "+f.message).addClass("error")}throw f},subscribe:function(){var g=d.Page.buttons;var f=d.Page.$droplabel;d.sub("file.icon.done",function(h){if(d.iconQueue.length===1){f.fadeOut("fast");g.$generate.removeClass("disabled");g.$clear.removeClass("disabled")}g.$sprite.addClass("disabled");g.$stylesheet.addClass("disabled")});d.sub("file.remove.done",function(h){if(d.iconQueue.length<1){f.fadeIn("fast");g.$generate.addClass("disabled");g.$clear.addClass("disabled")}g.$sprite.addClass("disabled");g.$stylesheet.addClass("disabled")});d.sub("sprite.generate.done",function(j,i){var k;var h;try{k=d.dataToObjectURL(j);h=d.dataToObjectURL(i);j=k;i=h}catch(l){}g.$sprite.attr("href",j).removeClass("disabled");g.$stylesheet.attr("href",i).removeClass("disabled")})},_noop:function(f){f.preventDefault();f.stopPropagation()},bindDragAndDrop:function(){var f=d.Page.$dropbox.get(0);f.addEventListener("dragenter",d.Page._dragStart,false);f.addEventListener("dragleave",d.Page._dragStop,false);f.addEventListener("dragexit",d.Page._dragStop,false);f.addEventListener("dragover",d.Page._noop,false);f.addEventListener("drop",d.Page._drop,false)},_dragStart:function(f){d.Page.$dropbox.addClass("dropping")},_dragStop:function(f){if(b(f.target).parents(".dropbox").length===0){d.Page.$dropbox.removeClass("dropping")}},_drop:function(h){h.stopPropagation();h.preventDefault();d.Page.$dropbox.removeClass("dropping");var f=h||a.event;var g=(f.files||f.dataTransfer.files);if(g.length>0){d.pub("page.drop.done",g)}},bindButtons:function(){var f=d.Page.$elem;f.delegate("a.disabled","click",d.Page._noop);f.delegate("a.generate","click",d.Page._generate);f.delegate("a.remove","click",d.Page._removeFile);f.delegate("a.clear","click",d.Page._removeAllFiles)},bindCabinet:function(){var h=d.Page.$elem;var i=d.Page.$stitches;var f=d.Page.$options;var j=d.Page.$drawer;var g=b("form.cabinet",j);var k=b("input.files",j);i.hover(function(){j.stop().animate({left:"-5px"},250)},function(){j.stop().animate({left:"-125px"},250)});k.bind("change",function(){if(this.files.length){d.pub("page.drop.done",this.files)}g.trigger("reset")});j.delegate("a.open-options","click",function(){f.fadeIn()})},bindOptions:function(){var f=d.Page.$options;var g=d.Page.buttons;f.delegate("a.close-options","click",function(){f.fadeOut()});f.delegate("input","change",function(){g.$sprite.addClass("disabled");g.$stylesheet.addClass("disabled")});f.delegate("input[name=prefix]","change",function(){d.settings.prefix=d.Page.inputs.$prefix.val()});f.delegate("input[name=padding]","change",function(){var h=d.Page.inputs.$padding.val();d.settings.padding=+h;d.Page.updateIconDimensions()});f.delegate("input[name=dataURI]","change",function(){var h=d.Page.inputs.$dataURI.filter(":checked").val();d.settings.dataURI=h==="true"?true:false})},_generate:function(f){d.pub("sprite.generate",[].concat(d.iconQueue))},_removeFile:function(g){var f=b(this).parent("li").data("icon");d.pub("file.unqueue",f)},_removeAllFiles:function(f){d.pub("file.unqueue.all")},addIcon:function(f){b(d.Page.templates.icon(f)).data("icon",f).appendTo(d.Page.$filelist).fadeIn("fast")},removeIcon:function(f){d.Page.$filelist.find("li").filter(function(){return b(this).data("icon")===f}).fadeOut("fast").remove()},updateIconDimensions:function(){var f=d.settings.padding;b.each(d.iconQueue,function(g,h){h.width=h.image.width+f;h.height=h.image.height+f})}}})()})(window,Stitches,jQuery);(function(a,c,b){c.File=(function(){var e=a.Stitches;var d=[];return{queueFiles:function(f){b.each(f,function(h,g){if(/jpeg|png|gif/.test(g.type)){d.push(g);e.pub("file.queue.done",g)}})},queueIcons:function(){var g,f;g=d.shift();if(g){try{f=new FileReader();f.onloadend=function(j){var i=new e.Icon(g.name,j.target.result);e.iconQueue.push(i);e.pub("file.icon.done",i)};f.readAsDataURL(g)}catch(h){e.pub("page.error",h)}}},unqueueIcon:function(f){e.iconQueue=b.grep(e.iconQueue,function(g){return g!==f});e.Icon.clearNameCache(f.name);e.pub("file.remove.done",f)},unqueueAllIcons:function(){b.each(e.iconQueue,function(f,g){e.File.unqueueIcon(g)});e.Icon.clearNameCache()}}})()})(window,Stitches,jQuery);